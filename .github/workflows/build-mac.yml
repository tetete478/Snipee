name: Build Mac (Swift)

on:
  push:
    tags:
      - 'mac-v*'

jobs:
  build:
    runs-on: macos-14
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'
      
      - name: Import Certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.CSC_LINK }}
          CERTIFICATE_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
        run: |
          echo $CERTIFICATE_BASE64 | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
      
      - name: Update Version from Tag
        run: |
          VERSION=${GITHUB_REF#refs/tags/mac-v}
          echo "Version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      
      - name: Build
        run: |
          cd SnipeeMac/SnipeeMac
          xcodebuild -project SnipeeMac.xcodeproj \
            -scheme SnipeeMac \
            -configuration Release \
            -archivePath build/SnipeeMac.xcarchive \
            archive \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            DEVELOPMENT_TEAM=F8KR53ZN3Y \
            OTHER_CODE_SIGN_FLAGS="--options runtime" \
            ARCHS="arm64 x86_64" \
            ONLY_ACTIVE_ARCH=NO \
            MARKETING_VERSION=${{ env.VERSION }} \
            CURRENT_PROJECT_VERSION=${{ env.VERSION }}
      
      - name: Export
        run: |
          cd SnipeeMac/SnipeeMac
          xcodebuild -exportArchive \
            -archivePath build/SnipeeMac.xcarchive \
            -exportPath build/export \
            -exportOptionsPlist SnipeeMac/ExportOptions.plist
      
      - name: Notarize
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd SnipeeMac/SnipeeMac/build/export
          ditto -c -k --keepParent SnipeeMac.app SnipeeMac.app.zip
          SUBMISSION_OUTPUT=$(xcrun notarytool submit SnipeeMac.app.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$TEAM_ID" \
            --wait 2>&1) || true
          echo "$SUBMISSION_OUTPUT"
          SUBMISSION_ID=$(echo "$SUBMISSION_OUTPUT" | grep "id:" | head -1 | awk '{print $2}')
          echo "Submission ID: $SUBMISSION_ID"
          xcrun notarytool log "$SUBMISSION_ID" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$TEAM_ID"
          xcrun stapler staple SnipeeMac.app
      
      - name: Create DMG
        run: |
          cd SnipeeMac/SnipeeMac/build/export
          mkdir -p dmg_contents
          cp -R SnipeeMac.app dmg_contents/
          ln -s /Applications dmg_contents/Applications
          hdiutil create -volname "Snipee" -srcfolder dmg_contents -ov -format UDZO Snipee-Swift-${{ env.VERSION }}.dmg
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: SnipeeMac/SnipeeMac/build/export/Snipee-Swift-${{ env.VERSION }}.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Appcast
        run: |
          PUBDATE=$(date -u +"%a, %d %b %Y %H:%M:%S +0000")
          DMG_URL="https://github.com/tetete478/Snipee/releases/download/mac-v${VERSION}/Snipee-Swift-${VERSION}.dmg"
          echo '<?xml version="1.0" encoding="utf-8"?>' > docs/appcast-mac.xml
          echo '<rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle">' >> docs/appcast-mac.xml
          echo '  <channel>' >> docs/appcast-mac.xml
          echo '    <title>Snipee Mac Updates</title>' >> docs/appcast-mac.xml
          echo '    <item>' >> docs/appcast-mac.xml
          echo "      <title>Version ${VERSION}</title>" >> docs/appcast-mac.xml
          echo "      <pubDate>${PUBDATE}</pubDate>" >> docs/appcast-mac.xml
          echo "      <sparkle:version>${VERSION}</sparkle:version>" >> docs/appcast-mac.xml
          echo "      <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>" >> docs/appcast-mac.xml
          echo '      <sparkle:minimumSystemVersion>13.0</sparkle:minimumSystemVersion>' >> docs/appcast-mac.xml
          echo "      <enclosure url=\"${DMG_URL}\" type=\"application/octet-stream\" length=\"0\" />" >> docs/appcast-mac.xml
          echo '    </item>' >> docs/appcast-mac.xml
          echo '  </channel>' >> docs/appcast-mac.xml
          echo '</rss>' >> docs/appcast-mac.xml

      - name: Commit and Push Appcast
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/appcast-mac.xml
          git commit -m "Update appcast for mac-v${VERSION}" || echo "No changes"
          git push origin HEAD:main